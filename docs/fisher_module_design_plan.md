# Fisher钓鱼模块设计迭代计划 v1.0

## 项目概述
在modules/fisher/目录下重新设计钓鱼脚本模块，采用清晰的逻辑分离和模块化架构。

## 状态映射表
- 0: 等待上钩状态
- 1: 鱼上钩末提线状态  
- 2: 提线中_耐力未到二分之一状态
- 3: 提线中_耐力已到二分之一状态
- 4: 向右拉_txt (OCR识别)
- 5: 向左拉_txt (OCR识别)
- 6: 钓鱼成功状态_txt

## 系统资源
- 模型文件: `runs/fishing_model_latest.pt`
- OCR路径: `D:\Python\tool\Tesseract-OCR`

## 核心流程设计

### 主线程状态机
1. **初始阶段**: 识别状态0或1（3分钟超时）
2. **提线阶段**: 在状态2/3之间徘徊，控制鼠标点击
3. **成功阶段**: 识别状态6，处理完成动作
4. **抛竿阶段**: 模拟抛竿，进入下一轮

### 多线程架构
- **主线程**: 状态机逻辑控制
- **鼠标点击线程**: 状态1激活，状态3暂停，状态6停止
- **OCR识别线程**: 状态2/3激活，识别4/5并按键，状态6停止

## 模块架构设计

### 1. 配置管理模块 (config.py)
- 系统配置管理
- 热键配置
- 模型路径配置
- 超时时间配置

### 2. 模型检测器 (model_detector.py)
- YOLO模型加载和推理
- 状态0-3、6的识别
- 置信度阈值管理
- GPU/CPU自动选择

### 3. OCR检测器 (ocr_detector.py)
- Tesseract OCR初始化
- 状态4、5的文字识别
- 图像预处理优化
- 识别结果过滤

### 4. 输入控制器 (input_controller.py)
- 鼠标左键快速点击（线程安全）
- 键盘按键模拟（a键、d键、f键）
- 鼠标长按操作（抛竿）
- 随机时间间隔控制

### 5. 钓鱼控制器 (fishing_controller.py)
- 主状态机逻辑
- 多线程协调管理
- 超时处理机制
- 状态转换控制

### 6. UI界面模块 (ui.py)
- 主控制界面（开始/停止/设置按钮）
- 状态显示窗口（左上角透明显示）
- 设置对话框（热键配置、状态显示开关）
- 实时状态更新

### 7. 热键管理器 (hotkey_manager.py)
- 全局热键监听
- 开始/停止快捷键
- 紧急停止功能
- 热键配置动态加载

## 迭代计划

### 第一阶段：基础架构搭建
- [x] 创建项目结构
- [ ] 实现配置管理模块
- [ ] 实现模型检测器基础功能
- [ ] 实现OCR检测器基础功能
- [ ] 实现输入控制器基础功能

### 第二阶段：核心逻辑实现  
- [ ] 实现钓鱼控制器状态机
- [ ] 实现多线程协调机制
- [ ] 实现超时处理逻辑
- [ ] 基础功能测试

### 第三阶段：UI界面开发
- [ ] 实现主控制界面
- [ ] 实现状态显示窗口
- [ ] 实现设置对话框
- [ ] 实现热键管理器

### 第四阶段：集成测试与优化
- [ ] 完整流程集成测试
- [ ] 性能优化调整
- [ ] 错误处理完善
- [ ] 用户体验优化

## 技术要点

### 线程安全设计
- 使用threading.Event控制线程状态
- 线程间通信使用Queue或共享变量
- 确保资源访问的线程安全

### 性能优化
- 模型推理间隔优化
- OCR识别频率控制
- 内存使用优化
- CPU占用率控制

### 错误处理
- 模型加载失败处理
- OCR初始化异常处理
- 设备权限异常处理
- 网络连接异常处理

## 文件结构预览
```
modules/fisher/
├── __init__.py
├── config.py              # 配置管理
├── model_detector.py      # YOLO模型检测
├── ocr_detector.py        # OCR文字识别
├── input_controller.py    # 输入控制
├── fishing_controller.py  # 钓鱼控制器
├── ui.py                 # UI界面
├── hotkey_manager.py     # 热键管理
├── main.py              # 程序入口
├── config.yaml          # 配置文件
└── README.md           # 模块说明
```

## 当前状态
- 阶段：第二阶段 - 核心逻辑实现
- 任务：✅ 基础架构已完成，核心模块已实现
- 下一步：集成测试和调试优化

## 完成清单

### ✅ 第一阶段：基础架构搭建
- [x] 创建项目结构
- [x] 实现配置管理模块 (config.py)
- [x] 实现模型检测器基础功能 (model_detector.py)
- [x] 实现OCR检测器基础功能 (ocr_detector.py) 
- [x] 实现输入控制器基础功能 (input_controller.py)

### ✅ 第二阶段：核心逻辑实现  
- [x] 实现钓鱼控制器状态机 (fishing_controller.py)
- [x] 实现多线程协调机制
- [x] 实现超时处理逻辑
- [x] 创建配置文件 (config.yaml)

### ✅ 第三阶段：UI界面开发
- [x] 实现主控制界面 (ui.py)
- [x] 实现状态显示窗口
- [x] 实现设置对话框
- [x] 实现程序入口 (main.py)

### 📋 第四阶段：集成测试与优化
- [ ] 完整流程集成测试
- [ ] 性能优化调整
- [ ] 错误处理完善
- [ ] 用户体验优化

## 实现特色
- **完整状态机**: 实现了0→1→2/3→6的完整钓鱼流程
- **多线程架构**: 主控制、鼠标点击、OCR识别三线程协调
- **模块化设计**: 7个核心模块，职责清晰，耦合度低
- **配置驱动**: 灵活的YAML配置系统，支持热键自定义
- **UI分离**: 界面逻辑与业务逻辑完全分离
- **异常处理**: 完善的错误处理和资源清理机制

---
*文档创建时间: 2024-12-28*
*最后更新: 2024-12-28* 
*版本: v1.0*
*状态: 开发完成，待测试* 